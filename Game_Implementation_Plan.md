# Unity 世界切换平台游戏 - 完整设计文档

## 项目概述

2D平台游戏，玩家在粉色世界（正常物理）和紫色世界（0.6倍重力和移速）之间用鼠标左键即时切换。所有动作（移动、冲刺）都受当前世界物理倍率影响。允许冲刺中切换世界，包含完整UI反馈和检查点重生系统。

---

## 控制方案

- **A/D键**：左右移动
- **空格键**：跳跃
- **鼠标左键**：世界切换
- **鼠标右键**：冲刺（允许空中冲刺一次，落地重置）
- **R键**：快速重生到检查点
- **ESC键**：暂停/菜单

---

## 核心机制

### 世界规则

#### 世界A（粉色世界）
- **颜色**：粉色 #FFB3D9
- **重力倍率**：1.0（正常）
- **移动速度倍率**：1.0（正常）

#### 世界B（紫色世界）
- **颜色**：紫色 #D4A5FF
- **重力倍率**：0.6（低重力）
- **移动速度倍率**：0.6（减速）

### 运动机制

1. **移动系统**
   - 基础移动速度受世界影响
   - 实际移动速度 = 基础速度 × 当前世界speedMultiplier

2. **跳跃系统**
   - 跳跃初速度固定，不受世界影响
   - 在不同世界中，由于重力不同，跳跃弧线和高度会有差异
   - 世界A：正常跳跃弧线
   - 世界B：较慢的下落，跳得更高更远

3. **世界切换机制**
   - 切换是即时的，零延迟
   - 切换时玩家的velocity（速度向量）完全保持不变
   - 只改变：重力倍率、移动速度倍率、碰撞层
   - 可以在任何状态下切换（跑步、跳跃、下落、冲刺中）

4. **状态保持示例**
   - 玩家在世界A向上跳跃中（速度=10m/s向上）
   - 切换到世界B
   - 速度仍为10m/s向上，但重力变为0.6倍
   - 结果：会飞得更高

### 冲刺机制

1. **基本参数**
   - 持续时间：0.2秒
   - 冷却时间：1.5秒
   - 冲刺速度受当前世界speedMultiplier影响
   - 实际冲刺速度 = 基础冲刺速度 × 当前世界speedMultiplier

2. **方向控制**
   - 优先使用当前移动输入方向（AD键）
   - 如果没有输入，使用玩家当前朝向

3. **空中冲刺**
   - 允许在空中冲刺
   - 每次跳跃只能使用一次空中冲刺
   - 落地后重置，可以再次使用

4. **冲刺与世界切换**
   - 允许在冲刺过程中切换世界
   - 切换后冲刺继续，但速度会受新世界的speedMultiplier影响

### 重生系统

1. **检查点机制**
   - 玩家触碰检查点激活
   - 记录检查点位置
   - 死亡后重生到最后激活的检查点

2. **死亡触发**
   - 触碰障碍物（Hazard）
   - 掉出地图边界

3. **重生行为**
   - 玩家传送到检查点位置
   - 速度清零
   - 保持当前所在世界状态（不切换世界）

4. **快速重生**
   - 按R键立即重生到检查点
   - 用于玩家主动重置当前尝试

---

## 视觉设计

### 颜色方案

由于世界切换需要频繁发生，背景色调应相近但易于区分：

- **世界A背景色**：粉色 #FFB3D9
- **世界B背景色**：紫色 #D4A5FF
- **世界切换过渡**：0.2秒平滑颜色渐变

### 平台对象

1. **仅存在于世界A的平台**
   - 粉色 #FFB3D9
   - 只在世界A时可见和可碰撞

2. **仅存在于世界B的平台**
   - 紫色 #D4A5FF
   - 只在世界B时可见和可碰撞

3. **两个世界都存在的平台**
   - 白色
   - 在两个世界都可见和可碰撞

### 视觉反馈

1. **世界切换效果**
   - 相机背景色平滑过渡（0.2秒）
   - 玩家位置播放粒子特效（闪光）
   - 播放切换音效

2. **冲刺效果**
   - 拖尾效果（TrailRenderer）
   - 残影或速度线
   - 冲刺音效

3. **UI指示器**
   - 当前世界指示器（粉色/紫色图标）
   - 冲刺冷却进度条
   - 调试信息（速度、当前世界、倍率）

---

## 关卡设计

### 教学关卡流程

教学关卡直接引入所有机制，因为世界切换是游戏的核心：

1. **起点区域**
   - 两世界都存在的平台（白色）
   - UI提示：使用AD移动，空格跳跃

2. **世界A平台序列**
   - 只在世界A存在的粉色平台
   - UI提示：鼠标左键切换世界
   - 玩家必须在世界A才能前进

3. **世界B平台序列**
   - 只在世界B存在的紫色平台
   - 展示低重力特性
   - 玩家体验不同的跳跃手感

4. **第一个检查点**
   - 保存玩家进度

5. **远距跳跃挑战**
   - 需要利用世界B的低重力跳过大间隙
   - 在世界A无法完成

6. **冲刺教学区**
   - 有一个较大的缺口
   - UI提示：鼠标右键冲刺
   - 需要使用冲刺才能通过

7. **综合挑战区**
   - 交替出现的世界A和世界B平台
   - 需要频繁切换世界
   - 测试玩家对切换机制的理解

8. **障碍物区域**
   - 引入Hazard障碍物
   - 展示死亡和重生机制
   - 可能需要切换世界来避开障碍

9. **终点**
   - 完成教学关卡

### 关卡设计原则

1. **单一世界不足以完成**
   - 关卡设计确保玩家必须使用世界切换
   - 某些路径只在特定世界存在

2. **利用物理差异**
   - 世界B的低重力可以跳得更远
   - 世界A的正常移速更容易精确控制

3. **频繁切换**
   - 鼓励玩家频繁切换世界
   - 切换是思考工具，不是应急按钮

4. **渐进式难度**
   - 从简单的平台跳跃开始
   - 逐渐引入需要精确时机的切换
   - 最终组合所有机制

---

## 技术实现要点

### Unity项目结构

```
Assets/
├── Scripts/
│   ├── Player/
│   │   ├── PlayerController.cs          # 移动、跳跃、冲刺
│   │   ├── PlayerWorldSwitcher.cs       # 世界切换逻辑
│   │   └── DashEffect.cs                # 冲刺视觉效果
│   ├── World/
│   │   ├── WorldManager.cs              # 世界状态管理（单例）
│   │   ├── WorldRules.cs                # 世界规则（ScriptableObject）
│   │   ├── WorldSpecificObject.cs       # 世界特定对象组件
│   │   ├── WorldVisualController.cs     # 视觉过渡效果
│   │   ├── Hazard.cs                    # 障碍物
│   │   └── Checkpoint.cs                # 检查点
│   ├── Managers/
│   │   ├── GameManager.cs               # 游戏状态和暂停
│   │   ├── RespawnManager.cs            # 重生管理
│   │   ├── InputManager.cs              # 输入处理
│   │   └── CameraController.cs          # 相机跟随
│   └── UI/
│       ├── DashCooldownUI.cs            # 冲刺冷却显示
│       ├── WorldIndicatorUI.cs          # 世界指示器
│       └── DebugInfoUI.cs               # 调试信息
├── Prefabs/
│   ├── Platform/
│   │   ├── PlatformA.prefab             # 世界A平台（粉色）
│   │   ├── PlatformB.prefab             # 世界B平台（紫色）
│   │   └── PlatformBoth.prefab          # 两世界平台（白色）
│   ├── Hazard/
│   │   ├── Spike.prefab                 # 尖刺障碍
│   │   └── Pit.prefab                   # 陷阱
│   └── Checkpoint/
│       └── Checkpoint.prefab            # 检查点
├── Scenes/
│   └── TutorialLevel.unity              # 教学关卡
├── Materials/
│   ├── PinkMaterial.mat                 # 粉色材质
│   └── PurpleMaterial.mat               # 紫色材质
└── Audio/
    ├── SwitchSound.wav                  # 切换音效
    ├── JumpSound.wav                    # 跳跃音效
    ├── DashSound.wav                    # 冲刺音效
    └── DeathSound.wav                   # 死亡音效
```

### 物理层配置

Unity Layers：
- `WorldA` - 世界A的平台和对象
- `WorldB` - 世界B的平台和对象
- `Player` - 玩家
- `Hazard` - 障碍物

碰撞矩阵设置：
- Player 与 WorldA：在世界A时碰撞
- Player 与 WorldB：在世界B时碰撞
- Player 与 Hazard：始终碰撞

### 输入系统配置

使用Unity Input System（新输入系统）：

Action Map: `Player`
- `Movement` (Value, Axis, Composite) 
  - Positive: D键
  - Negative: A键
- `Jump` (Button)
  - Binding: Space
- `SwitchWorld` (Button)
  - Binding: Mouse Left Button
- `Dash` (Button)
  - Binding: Mouse Right Button
- `QuickRespawn` (Button)
  - Binding: R
- `Pause` (Button)
  - Binding: Escape

### 核心脚本职责

#### PlayerController.cs
- 处理左右移动（AD键输入）
- 处理跳跃（空格键）
- 处理冲刺（鼠标右键）
- 地面检测
- 状态机管理（Idle, Running, Jumping, Falling, Dashing）
- 应用当前世界的速度倍率

#### PlayerWorldSwitcher.cs
- 监听鼠标左键切换输入
- 调用WorldManager切换世界
- 更新Rigidbody2D的gravityScale
- 更新碰撞层
- 通知PlayerController更新速度倍率
- **关键**：不修改velocity，保持运动连续性

#### WorldManager.cs
- 单例模式
- 维护当前世界状态（WorldA或WorldB）
- 提供GetCurrentRules()接口
- 触发OnWorldSwitched UnityEvent
- 管理两个WorldRules ScriptableObject的引用

#### WorldRules.cs (ScriptableObject)
- 存储gravityMultiplier
- 存储speedMultiplier
- 创建两个资源：
  - WorldA_Rules: gravity=1.0, speed=1.0
  - WorldB_Rules: gravity=0.6, speed=0.6

#### WorldSpecificObject.cs
- 定义对象属于哪个世界（WorldA/WorldB/Both）
- 订阅WorldManager的OnWorldSwitched事件
- 根据当前世界启用/禁用Collider2D
- 根据当前世界启用/禁用SpriteRenderer

### 关键技术细节

#### 世界切换时的物理连续性
```
切换前（世界A）：
- 位置: (10, 5)
- 速度: (3, 8) // 向右上跳跃中
- 重力倍率: 1.0

切换到世界B：
- 位置: (10, 5) // 不变
- 速度: (3, 8) // 不变！
- 重力倍率: 0.6 // 改变

结果：玩家继续向右上移动，但下落变慢，会飞得更高
```

#### 冲刺方向计算逻辑
```
1. 检查AD输入
   - 如果有输入：使用输入方向
   - 如果无输入：进入步骤2

2. 检查玩家朝向
   - 使用transform.localScale.x的符号
   - 正值=向右，负值=向左
```

#### 空中冲刺重置时机
```
- 玩家跳跃离地 → airDashUsed = false（可以使用）
- 玩家使用空中冲刺 → airDashUsed = true（已使用）
- 玩家再次落地 → airDashUsed = false（重置）
```

---

## 游戏参数配置

### PlayerController 参数
- `baseSpeed`: 5.0 (基础移动速度)
- `jumpForce`: 10.0 (跳跃初速度)
- `baseDashSpeed`: 15.0 (基础冲刺速度)
- `dashDuration`: 0.2 (冲刺持续时间，秒)
- `dashCooldown`: 1.5 (冲刺冷却时间，秒)
- `groundCheckRadius`: 0.2 (地面检测半径)

### WorldRules 参数

WorldA_Rules:
- `gravityMultiplier`: 1.0
- `speedMultiplier`: 1.0

WorldB_Rules:
- `gravityMultiplier`: 0.6
- `speedMultiplier`: 0.6

### 视觉参数
- 背景色过渡时间: 0.2秒
- 世界A颜色: #FFB3D9 (RGB: 255, 179, 217)
- 世界B颜色: #D4A5FF (RGB: 212, 165, 255)

---

## 音效需求

1. **世界切换音效**
   - 短促的"嗖"声
   - 频率较高，清脆
   - 不应过于突兀（因为会频繁触发）

2. **跳跃音效**
   - 轻快的弹跳声
   - 标准平台游戏跳跃音

3. **冲刺音效**
   - 快速移动的"刷"声
   - 略带能量感

4. **死亡音效**
   - 失败提示音
   - 不应过于惩罚性

5. **检查点激活音效**
   - 确认音
   - 给予正向反馈

---

## 后续扩展可能性

### 更多世界规则
- 高跳跃力世界（跳得更高）
- 反重力世界（重力向上）
- 传送带世界（持续横向力）
- 冰面世界（低摩擦力）

### 更多机制
- 双跳能力
- 墙壁跳跃
- 滑翔机制
- 抓钩/钩爪

### 关卡元素
- 移动平台
- 旋转障碍
- 可破坏方块
- 钥匙和门系统

### 视觉优化
- 更精细的粒子效果
- 世界切换的涟漪/波纹效果
- 动态光照
- 背景视差滚动

### 音效和音乐
- 动态背景音乐（随世界切换变化）
- 环境音效
- 更丰富的角色音效

### 游戏模式
- 计时挑战模式
- 最少切换次数挑战
- 速通模式
- 关卡编辑器

---

## 开发优先级

### 第一阶段：核心机制（必须）
1. 基础玩家移动和跳跃
2. 世界切换系统
3. 简单的测试关卡（几个平台）
4. 验证物理连续性

### 第二阶段：完善功能（必须）
1. 冲刺机制
2. 检查点和重生系统
3. 障碍物系统
4. 基础UI（世界指示器）

### 第三阶段：视觉和反馈（重要）
1. 背景颜色过渡
2. 粒子效果
3. 冲刺冷却UI
4. 音效集成

### 第四阶段：完整教学关卡（重要）
1. 设计完整的教学关卡流程
2. 添加UI提示
3. 调整难度曲线

### 第五阶段：优化和润色（可选）
1. 调试信息UI
2. 暂停菜单
3. 视觉优化
4. 音乐和高级音效

---

## 测试要点

### 核心机制测试
- [ ] 世界切换是否即时无延迟
- [ ] 切换时velocity是否保持不变
- [ ] 不同世界的重力倍率是否正确应用
- [ ] 移动速度倍率是否正确应用

### 冲刺系统测试
- [ ] 冲刺方向计算是否正确
- [ ] 冲刺冷却是否正常工作
- [ ] 空中冲刺限制是否生效
- [ ] 落地后空中冲刺是否正确重置
- [ ] 冲刺中切换世界是否正常

### 物理交互测试
- [ ] 在世界A跳跃中切换到世界B，是否飞得更高
- [ ] 在世界B下落中切换到世界A，是否下落加速
- [ ] 冲刺在不同世界的速度差异是否明显
- [ ] 碰撞检测是否正确（只与当前世界的平台碰撞）

### 重生系统测试
- [ ] 检查点激活是否正常
- [ ] 死亡后重生到正确位置
- [ ] 重生后速度是否清零
- [ ] 重生后保持当前世界状态
- [ ] R键快速重生是否工作

### UI测试
- [ ] 世界指示器颜色切换是否正确
- [ ] 冲刺冷却显示是否准确
- [ ] 调试信息是否实时更新

### 关卡设计测试
- [ ] 教学流程是否清晰
- [ ] 难度曲线是否合理
- [ ] 是否强制使用世界切换机制
- [ ] 是否展示了所有核心机制

---

## 已确认的设计决策

1. ✅ 冲刺受世界物理特性影响
2. ✅ 允许在冲刺过程中切换世界
3. ✅ 跳跃速度不变，跳跃高度有区别
4. ✅ 世界切换时速度完全保持不变（这是期望行为）
5. ✅ 教学关卡直接引入所有机制
6. ✅ 使用粉色和紫色作为两个世界的颜色
7. ✅ 使用检查点系统而非关卡起点重生
8. ✅ 冲刺方向使用输入优先，无输入时用朝向
9. ✅ 允许空中冲刺，每次跳跃限一次

---

## 总结

这是一个以**世界切换**为核心机制的2D平台游戏。游戏的独特之处在于：

1. **即时切换**：零延迟、零成本的世界切换
2. **物理连续性**：切换时运动状态完全保持，只改变物理规则
3. **频繁切换**：鼓励玩家将切换作为思考工具，而非应急手段
4. **规则差异**：利用两个世界的物理差异（重力、速度）解决空间谜题

游戏强调的是**规则理解和空间推理**，而非纯粹的反应速度和操作精度。

**核心设计理念**：用世界切换构建有效路径，而非单纯避险。
